package com.kurento.kas.media.codecs;

import com.kurento.kas.media.tx.VideoInfoTx;

public class VideoCodecParams {

//H.263
//Bits/(Pixel*Frame)
//			intra_only		gop2		gop3		gop4		gop5		gop10		gop20
//		gop	0				2				3				4				5				10				20
//		q
//q2	2	3.3563499579	2.7591671928	2.5563578493	2.472840383		2.3765651305	2.2803556397	2.2358349116
//q3	3	2.4255576599	1.9374079335	1.7739241372	1.7059922138	1.6299715909	1.5517150673	1.5156776094
//q4	4	1.9218881524	1.5044981061	1.3667929293	1.3079361322	1.2451993897	1.1790430345	1.1485295665
//q5	5	1.5678924663	1.2008101852	1.0881602483	1.0337752525	0.9891887626	0.9277014941	0.90027883
//q6	6	1.3286510943	1.0033933081	0.9031723485	0.8558238636	0.8151830808	0.7612584175	0.7371238426
//q8	8	1.0197022306	0.7541561448	0.6724142466	0.6330886995	0.6003393308	0.5565419823	0.536813447
//q10	10	0.8204440236	0.5972485269	0.5276725589	0.4947259049	0.4671717172	0.4301478325	0.4137073864
//q12	12	0.6926031145	0.497422138		0.4365924874	0.4075915404	0.3835227273	0.350641835		0.3364372896
//q14	14	0.6032328493	0.4288325968	0.3741845539	0.3480113636	0.3265730219	0.2970459806	0.2840909091
//q15	15	0.5684448653	0.4023963594	0.3501157407	0.3251920244	0.3044770623	0.2766598274	0.2641650884
//q20	20	0.4492845118	0.3113162879	0.267321654		0.2470012626	0.2303635311	0.206294718		0.1959043561
//q25	25	0.3831281566	0.2608769992	0.2218802609	0.2037300084	0.1889993687	0.1682844066	0.1582228535
//q31	31	0.3362400042	0.2257602062	0.1905118897	0.1738083965	0.1605902778	0.1417166456	0.1326415194

	private static double[][] H263_BITS_PER_PIX_FRAME = {
			{ 3.3563499579, 2.4255576599, 1.9218881524, 1.5678924663, 1.3286510943, 1.0197022306,
					0.8204440236, 0.6926031145, 0.6032328493, 0.5684448653, 0.4492845118, 0.3831281566, 0.3362400042 },
			{ 2.7591671928, 1.9374079335, 1.5044981061, 1.2008101852, 1.0033933081, 0.7541561448,
					0.5972485269, 0.497422138, 0.4288325968, 0.4023963594, 0.3113162879,
					0.2608769992, 0.2257602062},
			{ 2.5563578493, 1.7739241372, 1.3667929293, 1.0881602483, 0.9031723485, 0.6724142466,
					0.5276725589, 0.4365924874, 0.3741845539, 0.3501157407, 0.267321654,
					0.2218802609, 0.1905118897 },
			{ 2.472840383, 1.7059922138, 1.3079361322, 1.0337752525, 0.8558238636, 0.6330886995,
					0.4947259049, 0.4075915404, 0.3480113636, 0.3251920244, 0.2470012626,
					0.2037300084, 0.1738083965 },
			{ 2.3765651305, 1.6299715909, 1.2451993897, 0.9891887626, 0.8151830808, 0.6003393308,
					0.4671717172, 0.3835227273, 0.3265730219, 0.3044770623, 0.2303635311,
					0.1889993687, 0.1605902778 },
			{ 2.2803556397, 1.5517150673, 1.1790430345, 0.9277014941, 0.7612584175, 0.5565419823,
					0.4301478325, 0.350641835, 0.2970459806, 0.2766598274, 0.206294718,
					0.1682844066, 0.1417166456 },
			{ 2.2358349116, 1.5156776094, 1.1485295665, 0.90027883, 0.7371238426, 0.536813447,
					0.4137073864, 0.3364372896, 0.2840909091, 0.2641650884, 0.1959043561,
					0.1582228535, 0.1326415194 }
	};

//MPEG-4
//Bits/(Pixel*Frame)
//			intra_only		gop2			gop3			gop4			gop5			gop10			gop20
//		gop	0				2				3				4				5				10				20
//		q
//q2	2	2.679135101		2.3008075547	2.1976273148	2.1317340067	2.0736005892	2.0154014099	1.9904119318
//q3	3	1.9967908249	1.6333912037	1.5312631524	1.470038931		1.4184159301	1.3617950337	1.335753367
//q4	4	1.6164246633	1.2792639941	1.1818707912	1.126104798		1.0792824074	1.0277251684	1.0028672138
//q5	5	1.3275331439	1.0249631734	0.9364478114	0.8855481902	0.8447101221	0.7974931608	0.7750026305
//q6	6	1.1279461279	0.8539825337	0.7726352062	0.7275883838	0.6901041667	0.6475562921	0.626512521
//q8	8	0.860887521		0.6332202231	0.5627893519	0.5274752736	0.4982112795	0.4623711069	0.4456676136
//q10	10	0.6836595118	0.4928188131	0.4332386364	0.404040404		0.3790509259	0.3481428872	0.3340041035
//q12	12	0.5677872475	0.4031855008	0.3516282618	0.3266387837	0.3050689184	0.2792902988	0.2663352273
//q14	14	0.4853877315	0.3406460438	0.2952046507	0.2732402146	0.2539720118	0.2307581019	0.2201046928
//q15	15	0.4526383628	0.3164457071	0.2729771675	0.2529198232	0.2344407618	0.2126736111	0.2024147727
//q20	20	0.339659617		0.2330597643	0.1995212542	0.1830808081	0.1692708333	0.1521070076	0.1442813552
//q25	25	0.2744239268	0.1865661827	0.1580255682	0.1448732113	0.1336279461	0.1195549242	0.1131102694
//q31	31	0.2258917298	0.1526988636	0.1292876684	0.1184369739	0.1089015152	0.0969328704	0.0913431187

	private static double[][] MPEG4_BITS_PER_PIX_FRAME = {
			{ 2.679135101, 1.9967908249, 1.6164246633, 1.3275331439, 1.1279461279, 0.860887521,
					0.6836595118, 0.5677872475, 0.4853877315, 0.4526383628, 0.339659617,
					0.2744239268, 0.2258917298 },
			{ 2.3008075547, 1.6333912037, 1.2792639941, 1.0249631734, 0.8539825337, 0.6332202231,
					0.4928188131, 0.4031855008, 0.3406460438, 0.3164457071, 0.2330597643,
					0.1865661827, 0.1526988636 },
			{ 2.1976273148, 1.5312631524, 1.1818707912, 0.9364478114, 0.7726352062, 0.5627893519,
					0.4332386364, 0.3516282618, 0.2952046507, 0.2729771675, 0.1995212542,
					0.1580255682, 0.1292876684 },
			{ 2.1317340067, 1.470038931, 1.126104798, 0.8855481902, 0.7275883838, 0.5274752736,
					0.404040404, 0.3266387837, 0.2732402146, 0.2529198232, 0.1830808081,
					0.1448732113, 0.1184369739 },
			{ 2.0736005892, 1.4184159301, 1.0792824074, 0.8447101221, 0.6901041667, 0.4982112795,
					0.3790509259, 0.3050689184, 0.2539720118, 0.2344407618, 0.1692708333,
					0.1336279461, 0.1089015152 },
			{ 2.0154014099, 1.3617950337, 1.0277251684, 0.7974931608, 0.6475562921, 0.4623711069,
					0.3481428872, 0.2792902988, 0.2307581019, 0.2126736111, 0.1521070076,
					0.1195549242, 0.0969328704 },
			{ 1.9904119318, 1.335753367, 1.0028672138, 0.7750026305, 0.626512521, 0.4456676136,
					0.3340041035, 0.2663352273, 0.2201046928, 0.2024147727, 0.1442813552,
					0.1131102694, 0.0913431187 }
	};

	private static int[] GOP = { 0, 2, 3, 4, 5, 10, 20 };
	private static int[] QUANTIZER = { 2, 3, 4, 5, 6, 8, 10, 12, 14, 15, 20, 25, 31 };

	public static int getQMax(VideoInfoTx videoInfoTx) {
		double[][] codecBitsPerPixFrame = null;

		if (VideoCodecType.H263.equals(videoInfoTx.getVideoProfile().getVideoCodecType()))
			codecBitsPerPixFrame = H263_BITS_PER_PIX_FRAME;
		else if (VideoCodecType.MPEG4.equals(videoInfoTx.getVideoProfile().getVideoCodecType()))
			codecBitsPerPixFrame = MPEG4_BITS_PER_PIX_FRAME;

		if (codecBitsPerPixFrame == null)
			return 31;

		double bitsPerPixFrame = (double) videoInfoTx.getVideoProfile().getBitRate()
				/ (videoInfoTx.getVideoProfile().getWidth()
						* videoInfoTx.getVideoProfile().getHeight()
						* (double) videoInfoTx.getVideoProfile().getFrameRateNum() / videoInfoTx
						.getVideoProfile().getFrameRateDen());

		int gopPos = GOP.length - 1;
		for (int i = 0; i < GOP.length; i++) {
			if (GOP[i] > videoInfoTx.getVideoProfile().getGopSize()) {
				gopPos = i - 1;
				break;
			}
		}

		int qPos = QUANTIZER.length - 1;
		for (int i = 0; i < QUANTIZER.length; i++) {
			if (codecBitsPerPixFrame[gopPos][i] < bitsPerPixFrame) {
				qPos = i;
				break;
			}
		}

		return QUANTIZER[qPos];
	}

}
